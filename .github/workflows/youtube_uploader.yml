name: YouTube Upload (Senior OU News Parody)

on:
  schedule:
    - cron: '30 22 * * *'  # ë§¤ì¼ ì˜¤ì „ 7:30 KST
  workflow_dispatch:

jobs:
  upload_to_youtube:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository with LFS
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install YouTube uploader dependencies
        working-directory: ./youtube_uploader
        run: pip install -r requirements_youtube.txt

      - name: ğŸ” Restore authentication files
        run: |
          mkdir -p youtube_uploader
          echo "${{ secrets.YOUTUBE_CLIENT_SECRETS }}" > youtube_uploader/client_secrets.json
          printf "%s" '${{ secrets.YOUTUBE_TOKEN_JSON }}' > youtube_uploader/token.json
          echo "${{ secrets.GOOGLE_CREDENTIALS_JSON }}" > service_account.json

      - name: ğŸ‘€ Verify token.json content
        run: cat youtube_uploader/token.json

      - name: ğŸš€ Upload to YouTube
        run: python youtube_uploader/upload_to_youtube.py

      - name: ğŸ§¹ Clean up old video files
        run: |
          echo "ğŸ§¹ ì˜¤ë˜ëœ ë™ì˜ìƒ íŒŒì¼ ì •ë¦¬ ì¤‘..."
          cd parody_video
          
          # ìµœì‹  íŒŒì¼ ì°¾ê¸°
          latest_file=$(ls -t *.mp4 2>/dev/null | head -1)
          
          if [ -n "$latest_file" ]; then
            echo "ğŸ“¹ ìµœì‹  íŒŒì¼: $latest_file"
            
            # ìµœì‹  íŒŒì¼ì„ ì œì™¸í•œ ëª¨ë“  .mp4 íŒŒì¼ ì‚­ì œ
            for file in *.mp4; do
              if [ "$file" != "$latest_file" ] && [ -f "$file" ]; then
                echo "ğŸ—‘ï¸ ì‚­ì œ: $file"
                rm "$file"
              fi
            done
            
            echo "âœ… íŒŒì¼ ì •ë¦¬ ì™„ë£Œ"
          else
            echo "âš ï¸ ì‚­ì œí•  .mp4 íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
          fi

      - name: ğŸ§¹ Clean up LFS files from Git history
        run: |
          echo "ğŸ§¹ Git LFS íˆìŠ¤í† ë¦¬ì—ì„œ ì˜¤ë˜ëœ íŒŒì¼ ì œê±° ì¤‘..."
          
          # í˜„ì¬ parody_video í´ë”ì˜ íŒŒì¼ë“¤ í™•ì¸
          current_files=$(ls parody_video/*.mp4 2>/dev/null | xargs -n1 basename 2>/dev/null || echo "")
          echo "ğŸ“ í˜„ì¬ íŒŒì¼ë“¤: $current_files"
          
          # LFSë¡œ ì¶”ì ë˜ëŠ” íŒŒì¼ë“¤ í™•ì¸
          lfs_files=$(git lfs ls-files | grep "parody_video" | awk '{print $3}' | xargs -n1 basename 2>/dev/null || echo "")
          echo "ğŸ”— LFS ì¶”ì  íŒŒì¼ë“¤: $lfs_files"
          
          # LFSì—ì„œ ì¶”ì  ì¤‘ì´ì§€ë§Œ í˜„ì¬ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” íŒŒì¼ë“¤ ì°¾ê¸°
          for lfs_file in $lfs_files; do
            if [ -n "$lfs_file" ] && ! echo "$current_files" | grep -q "$lfs_file"; then
              echo "ğŸ—‘ï¸ LFSì—ì„œ ì œê±°: parody_video/$lfs_file"
              git lfs untrack "parody_video/$lfs_file" 2>/dev/null || true
              git rm --cached "parody_video/$lfs_file" 2>/dev/null || true
            fi
          done
          
          echo "âœ… LFS ì •ë¦¬ ì™„ë£Œ"

      - name: ğŸ“Š Show remaining files
        run: |
          echo "ğŸ“ parody_video í´ë” ë‚¨ì€ íŒŒì¼:"
          ls -la parody_video/ || echo "í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤"
          
          echo "ğŸ”— LFS ì¶”ì  íŒŒì¼ë“¤:"
          git lfs ls-files | grep "parody_video" || echo "LFS íŒŒì¼ ì—†ìŒ"