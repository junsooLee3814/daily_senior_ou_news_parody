name: YouTube Upload (Senior OU News Parody)

on:
  schedule:
    - cron: '30 22 * * *'  # ë§¤ì¼ ì˜¤ì „ 7:30 KST
  workflow_dispatch:

jobs:
  upload_to_youtube:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Git LFS pull
        run: |
          git lfs install
          git lfs pull

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        working-directory: ./youtube_uploader
        run: pip install -r requirements_youtube.txt

      - name: Install additional dependencies
        run: |
          pip install google-auth-oauthlib
          pip install google-auth-httplib2
          pip install google-api-python-client

      - name: Restore YouTube authentication files
        run: |
          mkdir -p youtube_uploader
          echo "${{ secrets.YOUTUBE_CLIENT_SECRETS }}" > youtube_uploader/client_secrets.json
          echo "${{ secrets.YOUTUBE_TOKEN_JSON }}" > youtube_uploader/token.json

      - name: Restore Google Sheets authentication file
        run: |
          echo "${{ secrets.GOOGLE_CREDENTIALS_JSON }}" > service_account.json

      - name: Auto-refresh YouTube token if needed
        run: |
          echo "=== YouTube í† í° ìë™ ìƒˆë¡œê³ ì¹¨ ==="
          python -c "
          import json
          import os
          from datetime import datetime
          from google.oauth2.credentials import Credentials
          from google.auth.transport.requests import Request
          
          try:
              # í† í° íŒŒì¼ ì¡´ì¬ í™•ì¸
              if not os.path.exists('youtube_uploader/token.json'):
                  print('âŒ í† í° íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.')
                  exit(1)
              
              # í† í° íŒŒì¼ í¬ê¸° í™•ì¸
              token_size = os.path.getsize('youtube_uploader/token.json')
              if token_size == 0:
                  print('âŒ í† í° íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.')
                  exit(1)
              
              print(f'ğŸ“„ í† í° íŒŒì¼ í¬ê¸°: {token_size} bytes')
              
              # í† í° ë¡œë“œ
              creds = Credentials.from_authorized_user_file('youtube_uploader/token.json', 
                                                          ['https://www.googleapis.com/auth/youtube.upload'])
              
              print(f'ğŸ“… í† í° ë§Œë£Œì¼: {creds.expiry}')
              print(f'â° í˜„ì¬ ì‹œê°„: {datetime.now()}')
              
              # ë§Œë£Œ ì²´í¬ ë° ìƒˆë¡œê³ ì¹¨
              if creds.expired and creds.refresh_token:
                  print('ğŸ”„ í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ì„ ì‹œë„í•©ë‹ˆë‹¤...')
                  creds.refresh(Request())
                  
                  # ìƒˆë¡œê³ ì¹¨ëœ í† í° ì €ì¥
                  with open('youtube_uploader/token.json', 'w') as f:
                      f.write(creds.to_json())
                  print('âœ… í† í° ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ!')
              elif not creds.valid:
                  print('âŒ í† í°ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')
                  exit(1)
              else:
                  print('âœ… í† í°ì´ ìœ íš¨í•©ë‹ˆë‹¤.')
                  
          except Exception as e:
              print(f'âŒ í† í° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}')
              exit(1)
          "

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Check video files and token status
        run: |
          echo "=== ì—…ë¡œë“œ ì¤€ë¹„ ìƒíƒœ í™•ì¸ ==="
          
          # ë¹„ë””ì˜¤ íŒŒì¼ í™•ì¸
          echo "ğŸ“¹ ë¹„ë””ì˜¤ íŒŒì¼ í™•ì¸:"
          if [ -d "parody_video" ]; then
            find parody_video -name "*.mp4" -type f
            echo "ğŸ“Š íŒŒì¼ í¬ê¸°:"
            for file in parody_video/*.mp4; do
              if [ -f "$file" ]; then
                size=$(du -h "$file" | cut -f1)
                echo "$(basename "$file"): $size"
              fi
            done
          else
            echo "âŒ parody_video ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          # í† í° ìƒíƒœ í™•ì¸
          echo "ğŸ”‘ í† í° ìƒíƒœ í™•ì¸:"
          python -c "
          import json
          token_data = json.load(open('youtube_uploader/token.json'))
          print(f'ê¶Œí•œ ë²”ìœ„: {token_data.get(\"scopes\", \"ì—†ìŒ\")}')
          print(f'ë§Œë£Œì¼: {token_data.get(\"expiry\", \"ì—†ìŒ\")}')
          print(f'ë¦¬í”„ë ˆì‹œ í† í°: {\"ìˆìŒ\" if token_data.get(\"refresh_token\") else \"ì—†ìŒ\"}')
          "

      - name: Upload to YouTube
        run: python youtube_uploader/upload_to_youtube.py
        env:
          PYTHONUNBUFFERED: 1