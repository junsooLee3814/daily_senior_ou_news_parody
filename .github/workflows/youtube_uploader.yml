name: YouTube Upload (Senior OU News Parody)

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 4:30 KST (ì „ë‚  19:30 UTC)ì— ì‹¤í–‰
    - cron: '30 19 * * *'
  workflow_dispatch:

jobs:
  upload_to_youtube:
    runs-on: ubuntu-latest
    env:
      GSHEET_ID: ${{ secrets.GSHEET_ID }}
      GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
      YOUTUBE_CLIENT_SECRETS: ${{ secrets.YOUTUBE_CLIENT_SECRETS }}
      YOUTUBE_TOKEN_JSON: ${{ secrets.YOUTUBE_TOKEN_JSON }}
      CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
      TZ: Asia/Seoul
    steps:
      - name: ğŸ“¥ Checkout repository with LFS
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: pip install -r youtube_uploader/requirements_youtube.txt

      - name: ğŸ” Restore authentication files
        run: |
          mkdir -p youtube_uploader
          printf "%s" '${{ secrets.YOUTUBE_CLIENT_SECRETS }}' > youtube_uploader/client_secrets.json
          printf "%s" '${{ secrets.YOUTUBE_TOKEN_JSON }}' > youtube_uploader/token.json
          printf "%s" '${{ secrets.GOOGLE_CREDENTIALS_JSON }}' > service_account.json
          
          # JSON íŒŒì¼ ê²€ì¦
          echo "ğŸ” JSON íŒŒì¼ ê²€ì¦ ì¤‘..."
          python -c "import json; json.load(open('service_account.json')); print('âœ… service_account.json ìœ íš¨í•¨')"
          python -c "import json; json.load(open('youtube_uploader/token.json')); print('âœ… token.json ìœ íš¨í•¨')"
          python -c "import json; json.load(open('youtube_uploader/client_secrets.json')); print('âœ… client_secrets.json ìœ íš¨í•¨')"

      - name: ğŸ” Check video files
        run: |
          echo "ğŸ“ parody_video directory check..."
          echo "â° Current time: $(date)"
          echo "ğŸŒ Timezone: $(date +%Z)"
          
          if [ -d "parody_video" ]; then
            echo "âœ… parody_video directory exists"
            echo "ğŸ“‹ Directory contents:"
            ls -la parody_video/
            
            # Count MP4 files
            mp4_count=$(find parody_video -name "*.mp4" | wc -l)
            echo "ğŸ“¹ MP4 file count: $mp4_count"
            
            if [ $mp4_count -eq 0 ]; then
              echo "âŒ No video files to upload."
              echo "ğŸ’¡ Please check if video generation workflow completed."
              exit 1
            fi
            
            # Detailed file information
            echo "ğŸ“Š MP4 file details:"
            for file in parody_video/*.mp4; do
              if [ -f "$file" ]; then
                size=$(du -h "$file" | cut -f1)
                mtime=$(stat -c %y "$file")
                echo "   ğŸ“¹ $(basename "$file") - Size: $size, Modified: $mtime"
              fi
            done
          else
            echo "âŒ parody_video directory not found."
            exit 1
          fi

      - name: ğŸš€ Upload to YouTube
        run: |
          echo "ğŸ” Environment check:"
          echo "Current directory: $(pwd)"
          echo "Contents: $(ls -la)"
          echo "youtube_uploader/upload_to_youtube.py exists: $(test -f youtube_uploader/upload_to_youtube.py && echo 'YES' || echo 'NO')"
          
          echo "ğŸ Python environment:"
          echo "Python version: $(python --version)"
          
          echo "ğŸš€ Starting YouTube upload (no utils dependency)..."
          python youtube_uploader/upload_to_youtube.py

      - name: ğŸ§¹ Clean up old video files
        run: |
          echo "ğŸ§¹ Cleaning up old video files..."
          if [ -d "parody_video" ]; then
            # Find latest file (by filename)
            echo "ğŸ“Š File creation time check:"
            for file in parody_video/*.mp4; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                # Extract date/time from filename (senior_ou_news_parody_20250721_072003.mp4)
                date_part=$(echo "$filename" | grep -o '2025[0-9]{4}_[0-9]{6}' | head -1)
                if [ -n "$date_part" ]; then
                  echo "   ğŸ“¹ $filename - Created: $date_part"
                else
                  echo "   ğŸ“¹ $filename - No time info"
                fi
              fi
            done
            
            # Find latest file by filename (date+time reverse sort)
            latest_file=$(find parody_video -name "*.mp4" | while read file; do
              filename=$(basename "$file")
              date_part=$(echo "$filename" | grep -o '2025[0-9]{4}_[0-9]{6}' | head -1)
              if [ -n "$date_part" ]; then
                echo "$date_part $file"
              else
                echo "00000000000000 $file"  # Files without time info go to end
              fi
            done | sort -r | head -1 | cut -d' ' -f2-)
            
            echo "ğŸ“¹ Selected latest file: $(basename "$latest_file")"
            
            # Delete old files (including LFS files)
            deleted_count=0
            for file in parody_video/*.mp4; do
              if [ -f "$file" ] && [ "$file" != "$latest_file" ]; then
                echo "ğŸ—‘ï¸ Deleting: $(basename "$file")"
                # Remove from LFS too
                git lfs untrack "$file" 2>/dev/null || true
                rm "$file"
                deleted_count=$((deleted_count + 1))
              fi
            done
            echo "âœ… Cleanup complete: $deleted_count files deleted"
            
            # Commit deleted files to Git
            if [ $deleted_count -gt 0 ]; then
              echo "ğŸ“ Committing deleted files to Git..."
              git add -A
              git config --local user.email "action@github.com"
              git config --local user.name "GitHub Action"
              git commit -m "ğŸ§¹ Cleaned up old video files - $deleted_count files deleted" || echo "âš ï¸ Commit failed (no changes)"
              git push || echo "âš ï¸ Push failed"
            fi
          else
            echo "âš ï¸ parody_video directory not found."
          fi

      - name: ğŸ§¹ Clean up LFS storage
        run: |
          echo "ğŸ§¹ Cleaning up Git LFS storage..."
          git lfs prune --force

          echo "âœ… LFS cleanup complete" 


